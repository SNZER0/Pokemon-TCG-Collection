<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon TCG Collection Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .card-image {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-image:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        #loading-indicator {
            transition: opacity 0.3s ease-in-out;
        }
        /* Themed Poké Ball Loader */
        .pokeball {
            width: 60px;
            height: 60px;
            background-color: #fff;
            border-radius: 50%;
            position: relative;
            border: 3px solid #000;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        .pokeball::before,
        .pokeball::after {
            content: '';
            position: absolute;
        }
        .pokeball::before {
            background-color: #f00;
            width: 100%;
            height: 50%;
            left: 0;
            top: 0;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
        }
        .pokeball::after {
            width: 18px;
            height: 18px;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #000;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl relative">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-400 mb-2">Pokémon TCG Collection</h1>
            <p class="text-gray-400">Browse cards and build your session-only collection.</p>
            <div class="mt-2 text-sm bg-red-800/50 border border-red-600 text-red-200 rounded-md p-2 max-w-lg mx-auto">
                Note: Your collection is temporary and will reset if you refresh the page. Download your collection before leaving.
            </div>
             <!-- Settings Button -->
            <div class="absolute top-4 right-4">
                <button id="settings-btn" class="text-gray-400 hover:text-yellow-400 transition-colors" title="API Key Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Search and Navigation -->
        <div class="sticky top-0 z-20 bg-gray-900/80 backdrop-blur-sm py-4 mb-8">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <form id="search-form" class="w-full md:w-1/2">
                    <input type="text" id="search-input" placeholder="Search for a card by name..." class="w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg focus:outline-none focus:border-yellow-400 transition-colors">
                </form>
                <div class="flex gap-4">
                    <button id="browse-btn" class="bg-yellow-500 text-gray-900 font-bold py-2 px-5 rounded-lg shadow-md hover:bg-yellow-400 transition-all">Browse Cards</button>
                    <button id="collection-btn" class="relative bg-gray-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        My Collection
                        <span id="collection-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center p-10">
            <div class="pokeball"></div>
            <p class="mt-4 text-gray-400">Searching for Pokémon...</p>
        </div>

        <!-- Card Display Area -->
        <div id="browse-view">
            <div id="card-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                <!-- Cards will be injected here -->
            </div>
            <div id="load-more-container" class="text-center mt-8">
                <!-- Load More button will be injected here -->
            </div>
        </div>

        <!-- Collection Display Area -->
        <div id="collection-view" class="hidden">
             <!-- Collection Header with Actions -->
            <div id="collection-header" class="flex flex-col md:flex-row justify-center md:justify-between items-center gap-4 mb-6">
                <div id="collection-actions" class="flex-grow text-center md:text-left">
                    <!-- Download button will be injected here by JS -->
                </div>
                <div id="sort-container" class="flex items-center gap-2">
                    <label for="sort-select" class="font-semibold text-gray-300">Sort by:</label>
                    <select id="sort-select" class="bg-gray-700 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="hp-desc">HP (High to Low)</option>
                        <option value="hp-asc">HP (Low to High)</option>
                        <option value="date-desc">Release Date (Newest)</option>
                        <option value="date-asc">Release Date (Oldest)</option>
                    </select>
                </div>
            </div>
            <div id="collection-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                <!-- Collection cards will be injected here -->
            </div>
            <div id="empty-collection-msg" class="hidden text-center py-16">
                <h3 class="text-2xl font-semibold text-gray-300">Your Collection is Empty</h3>
                <p class="text-gray-500 mt-2">Go to the "Browse Cards" section to add your favorite cards!</p>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="card-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-gray-800 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto flex flex-col md:flex-row gap-6 p-6 relative transform transition-transform duration-300 scale-95">
            <!-- Content will be injected here -->
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl max-w-md w-full p-6 md:p-8 shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">API Key Required</h2>
            <p class="text-gray-400 mb-6">Please enter your API key from <a href="https://pokemontcg.io" target="_blank" rel="noopener noreferrer" class="text-yellow-500 hover:underline">pokemontcg.io</a> to use the app. Your key is saved locally in your browser.</p>
            <form id="api-key-form">
                <input type="text" id="api-key-input" placeholder="Enter your API key..." class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-yellow-400 transition-colors mb-4">
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg transition-colors">Save and Start</button>
            </form>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const cardResults = document.getElementById('card-results');
        const collectionResults = document.getElementById('collection-results');
        const loadingIndicator = document.getElementById('loading-indicator');
        const browseBtn = document.getElementById('browse-btn');
        const collectionBtn = document.getElementById('collection-btn');
        const browseView = document.getElementById('browse-view');
        const collectionView = document.getElementById('collection-view');
        const collectionActions = document.getElementById('collection-actions');
        const emptyCollectionMsg = document.getElementById('empty-collection-msg');
        const collectionCount = document.getElementById('collection-count');
        const cardModal = document.getElementById('card-modal');
        const modalContent = document.getElementById('modal-content');
        const loadMoreContainer = document.getElementById('load-more-container');
        const sortSelect = document.getElementById('sort-select');
        const sortContainer = document.getElementById('sort-container');
        const settingsBtn = document.getElementById('settings-btn');
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyForm = document.getElementById('api-key-form');
        const apiKeyInput = document.getElementById('api-key-input');

        // --- State Management (In-Memory) ---
        let myCollection = [];
        let currentView = 'browse';
        let currentPage = 1;
        let currentSearchQuery = '';
        let isLoadingMore = false;
        let currentSortBy = 'name-asc';
        let userApiKey = ''; // Will hold the API key from localStorage

        // --- API Configuration ---
        const API_BASE_URL = 'https://api.pokemontcg.io/v2/cards';
        
        // --- Functions ---

        /**
         * Shows the API Key input modal.
         */
        function showApiKeyModal() {
            apiKeyInput.value = userApiKey || '';
            apiKeyModal.classList.remove('hidden');
        }

        /**
         * Hides the API Key input modal.
         */
        function hideApiKeyModal() {
            apiKeyModal.classList.add('hidden');
        }

        /**
         * Saves the API key to localStorage and initializes the app.
         * @param {Event} e - The form submission event.
         */
        function saveApiKey(e) {
            e.preventDefault();
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('pokemonTcgApiKey', key);
                userApiKey = key;
                hideApiKeyModal();
                cardResults.innerHTML = ''; // Clear any "enter key" messages
                fetchCards('');
            }
        }

        /**
         * Fetches a URL with a retry mechanism for server errors and timeouts.
         * @param {string} url - The URL to fetch.
         * @param {object} options - The options for the fetch request.
         * @param {number} retries - The number of retry attempts.
         * @param {number} backoff - The initial backoff delay in ms.
         * @returns {Promise<Response>} The fetch response.
         */
        async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15-second timeout

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId); // Clear the timeout if the request succeeds

                    if (!response.ok) {
                        if (response.status >= 500 && response.status < 600) {
                            throw new Error(`Server error! status: ${response.status}`);
                        }
                        if (response.status === 401 || response.status === 403) {
                            throw new Error(`Authentication error (${response.status}). Check API key.`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response; // Success
                } catch (error) {
                    clearTimeout(timeoutId); // Also clear timeout on failure
                    let message = error.message;
                    if (error.name === 'AbortError') {
                        message = 'Request timed out.';
                    }
                    console.warn(`Attempt ${i + 1} failed: ${message}. Retrying in ${backoff}ms...`);
                    if (i === retries - 1) throw new Error(`Failed after ${retries} attempts: ${message}`);
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    backoff *= 2;
                }
            }
        }

        /**
         * Fetches cards from the Pokémon TCG API.
         * @param {string} query - The search query.
         * @param {number} page - The page number to fetch.
         */
        async function fetchCards(query, page = 1) {
            if (!userApiKey) {
                showApiKeyModal();
                cardResults.innerHTML = `<p class="col-span-full text-center text-yellow-400 p-4 rounded-md bg-yellow-900/50">Please add your Pokémon TCG API Key in the settings to fetch cards.</p>`;
                return;
            }

            if (query !== currentSearchQuery) {
                currentPage = 1;
                currentSearchQuery = query;
                cardResults.innerHTML = '';
                hideLoadMoreButton();
            }

            isLoadingMore = page > 1;
            showLoading(true);

            try {
                const pageSize = 12;
                const apiUrl = query 
                    ? `${API_BASE_URL}?q=name:${query}*&page=${page}&pageSize=${pageSize}` 
                    : `${API_BASE_URL}?q=supertype:pokemon&page=${page}&pageSize=${pageSize}`;
                
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;

                const response = await fetchWithRetry(proxyUrl, { headers: { 'X-Api-Key': userApiKey } });
                
                const data = await response.json();
                renderCards(data.data, cardResults);

                if (!query && data.data.length === pageSize) {
                    showLoadMoreButton();
                } else {
                    hideLoadMoreButton();
                }

            } catch (error) {
                console.error("Failed to fetch cards:", error);
                cardResults.innerHTML = `<p class="col-span-full text-center text-red-400 p-4 rounded-md bg-red-900/50">Could not fetch cards. ${error.message}</p>`;
            } finally {
                showLoading(false);
                isLoadingMore = false;
            }
        }

        /**
         * Renders cards, appending them to the container.
         * @param {Array} cards - An array of card objects.
         * @param {HTMLElement} container - The DOM element to render cards into.
         */
        function renderCards(cards, container) {
            if (!cards || cards.length === 0) {
                if (container.innerHTML.trim() === '') {
                    container.innerHTML = `<p class="col-span-full text-center text-gray-400">No cards found for your search.</p>`;
                }
                return;
            }
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'cursor-pointer group';
                cardElement.innerHTML = `<img src="${card.images.small}" alt="${card.name}" class="w-full rounded-lg shadow-lg card-image" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/245x342/1a202c/4a5568?text=No+Image';">`;
                cardElement.addEventListener('click', () => showCardDetail(card));
                container.appendChild(cardElement);
            });
        }
        
        /** Sorts the collection based on the currentSortBy state. */
        function sortCollection() {
            myCollection.sort((a, b) => {
                switch (currentSortBy) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'hp-desc':
                        return parseInt(b.hp || 0) - parseInt(a.hp || 0);
                    case 'hp-asc':
                        return parseInt(a.hp || 0) - parseInt(b.hp || 0);
                    case 'date-desc':
                        return new Date(b.set.releaseDate) - new Date(a.set.releaseDate);
                    case 'date-asc':
                        return new Date(a.set.releaseDate) - new Date(b.set.releaseDate);
                    default:
                        return 0;
                }
            });
        }

        /** Renders the user's collection. */
        function renderCollection() {
            sortCollection();

            collectionResults.innerHTML = '';
            collectionActions.innerHTML = ''; 

            if (myCollection.length === 0) {
                emptyCollectionMsg.classList.remove('hidden');
                sortContainer.classList.add('hidden');
            } else {
                emptyCollectionMsg.classList.add('hidden');
                sortContainer.classList.remove('hidden');
                
                const downloadBtn = document.createElement('button');
                downloadBtn.id = 'download-collection-btn';
                downloadBtn.className = 'bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-500 transition-all disabled:bg-gray-500 disabled:cursor-wait';
                downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>Download Collection as Image`;
                downloadBtn.addEventListener('click', downloadCollectionAsImage);
                collectionActions.appendChild(downloadBtn);

                myCollection.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'relative group';
                    cardElement.innerHTML = `
                        <img src="${card.images.small}" alt="${card.name}" class="w-full rounded-lg shadow-lg card-image cursor-pointer" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/245x342/1a202c/4a5568?text=No+Image';">
                        <button class="remove-btn absolute top-2 right-2 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" data-card-id="${card.id}">&times;</button>`;
                    cardElement.querySelector('img').addEventListener('click', () => showCardDetail(card));
                    cardElement.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFromCollection(card.id);
                    });
                    collectionResults.appendChild(cardElement);
                });
            }
            updateCollectionCount();
        }
        
        /** Generates and downloads a single image of the collection. */
        async function downloadCollectionAsImage() {
            const downloadBtn = document.getElementById('download-collection-btn');
            if (!downloadBtn || myCollection.length === 0) return;
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<span>Preparing Image...</span>';

            const CARD_WIDTH = 734, CARD_HEIGHT = 1024, CARDS_PER_ROW = 5, PADDING = 50;
            const numRows = Math.ceil(myCollection.length / CARDS_PER_ROW);
            const canvasWidth = (CARDS_PER_ROW * CARD_WIDTH) + ((CARDS_PER_ROW + 1) * PADDING);
            const canvasHeight = (numRows * CARD_HEIGHT) + ((numRows + 1) * PADDING);

            const canvas = document.createElement('canvas');
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a202c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const imagePromises = myCollection.map(card => new Promise(resolve => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => resolve({ img, status: 'ok' });
                img.onerror = () => resolve({ img: null, status: 'error', cardName: card.name });
                img.src = `https://corsproxy.io/?${encodeURIComponent(card.images.large)}`;
            }));

            try {
                const imageResults = await Promise.all(imagePromises);
                imageResults.forEach((result, index) => {
                    const row = Math.floor(index / CARDS_PER_ROW), col = index % CARDS_PER_ROW;
                    const x = PADDING + col * (CARD_WIDTH + PADDING), y = PADDING + row * (CARD_HEIGHT + PADDING);
                    if (result.status === 'ok' && result.img) {
                        ctx.drawImage(result.img, x, y, CARD_WIDTH, CARD_HEIGHT);
                    } else {
                        ctx.fillStyle = '#2d3748';
                        ctx.fillRect(x, y, CARD_WIDTH, CARD_HEIGHT);
                        ctx.fillStyle = '#a0aec0';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '60px Inter';
                        ctx.fillText(result.cardName, x + CARD_WIDTH / 2, y + CARD_HEIGHT / 2 - 30, CARD_WIDTH - 40);
                        ctx.font = '40px Inter';
                        ctx.fillText('(Image failed to load)', x + CARD_WIDTH / 2, y + CARD_HEIGHT / 2 + 40, CARD_WIDTH - 40);
                    }
                });
                const link = document.createElement('a');
                link.download = 'pokemon-tcg-collection.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error("Error creating collection image:", error);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>Download Collection as Image`;
            }
        }

        /** Displays the card detail modal. */
        function showCardDetail(card) {
            const isCollected = myCollection.some(c => c.id === card.id);
            const buttonHtml = isCollected
                ? `<button class="w-full bg-gray-600 text-gray-400 font-bold py-3 px-6 rounded-lg cursor-not-allowed">Already in Collection</button>`
                : `<button id="add-to-collection-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg transition-colors">Add to Collection</button>`;
            modalContent.innerHTML = `
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
                <div class="w-full md:w-1/3 flex-shrink-0"><img src="${card.images.large}" alt="${card.name}" class="w-full rounded-lg shadow-2xl"></div>
                <div class="w-full md:w-2/3 text-left">
                    <h2 class="text-3xl font-bold">${card.name}</h2>
                    <p class="text-lg text-gray-400 mb-4">${card.supertype} - ${card.subtypes ? card.subtypes.join(', ') : ''}</p>
                    ${card.attacks ? card.attacks.map(a => `<div class="mb-3"><div class="flex justify-between items-center"><h4 class="font-semibold text-xl">${a.name}</h4><span class="font-bold text-xl">${a.damage}</span></div><p class="text-gray-400 text-sm">${a.text}</p></div>`).join('') : ''}
                    ${card.abilities ? card.abilities.map(a => `<div class="mb-3"><h4 class="font-semibold text-xl">${a.name} <span class="text-sm font-normal text-gray-500">(${a.type})</span></h4><p class="text-gray-400 text-sm">${a.text}</p></div>`).join('') : ''}
                    <div class="mt-6 pt-4 border-t border-gray-700">${buttonHtml}</div>
                </div>`;
            cardModal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-95'), 10);
            document.getElementById('close-modal-btn').addEventListener('click', hideCardDetail);
            const addBtn = document.getElementById('add-to-collection-btn');
            if (addBtn) addBtn.addEventListener('click', () => { addToCollection(card); hideCardDetail(); });
        }

        /** Hides the card detail modal. */
        function hideCardDetail() {
            modalContent.classList.add('scale-95');
            setTimeout(() => cardModal.classList.add('hidden'), 300);
        }

        /** Adds a card to the collection. */
        function addToCollection(card) {
            if (!myCollection.some(c => c.id === card.id)) {
                myCollection.push(card);
                updateCollectionCount();
                if (currentView === 'collection') renderCollection();
            }
        }

        /** Removes a card from the collection. */
        function removeFromCollection(cardId) {
            myCollection = myCollection.filter(card => card.id !== cardId);
            renderCollection();
        }

        /** Updates the collection count badge. */
        function updateCollectionCount() {
            collectionCount.textContent = myCollection.length;
        }

        /** Switches between browse and collection views. */
        function switchView(viewName) {
            currentView = viewName;
            browseView.classList.toggle('hidden', viewName !== 'browse');
            collectionView.classList.toggle('hidden', viewName !== 'collection');
            browseBtn.className = `font-bold py-2 px-5 rounded-lg shadow-md transition-all ${viewName === 'browse' ? 'bg-yellow-500 text-gray-900 hover:bg-yellow-400' : 'bg-gray-700 text-white hover:bg-gray-600'}`;
            collectionBtn.className = `relative font-bold py-2 px-5 rounded-lg shadow-md transition-all ${viewName === 'collection' ? 'bg-yellow-500 text-gray-900 hover:bg-yellow-400' : 'bg-gray-700 text-white hover:bg-gray-600'}`;
            if (viewName === 'collection') renderCollection();
        }
        
        /** Shows or hides the loading indicator. */
        function showLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
            loadingIndicator.classList.toggle('opacity-0', !isLoading);
        }

        /** Shows the 'Load More' button. */
        function showLoadMoreButton() {
            loadMoreContainer.innerHTML = `<button id="load-more-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-500 transition-all transform hover:scale-105 border-b-4 border-blue-800 hover:border-blue-700 active:border-b-0">Load More Pokémon</button>`;
            document.getElementById('load-more-btn').addEventListener('click', handleLoadMore);
        }

        /** Hides the 'Load More' button. */
        function hideLoadMoreButton() {
            loadMoreContainer.innerHTML = '';
        }

        /** Handles the click event for the 'Load More' button. */
        function handleLoadMore() {
            if (isLoadingMore) return;
            currentPage++;
            fetchCards(currentSearchQuery, currentPage);
        }

        // --- Event Listeners ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            switchView('browse');
            fetchCards(searchInput.value.trim(), 1);
        });

        browseBtn.addEventListener('click', () => switchView('browse'));
        collectionBtn.addEventListener('click', () => switchView('collection'));
        cardModal.addEventListener('click', (e) => { if (e.target === cardModal) hideCardDetail(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !cardModal.classList.contains('hidden')) hideCardDetail(); });

        sortSelect.addEventListener('change', (e) => {
            currentSortBy = e.target.value;
            renderCollection();
        });

        settingsBtn.addEventListener('click', showApiKeyModal);
        apiKeyForm.addEventListener('submit', saveApiKey);
        apiKeyModal.addEventListener('click', (e) => { if (e.target === apiKeyModal) hideApiKeyModal(); });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            userApiKey = localStorage.getItem('pokemonTcgApiKey');
            fetchCards('');
            switchView('browse');
        });
    </script>
</body>
</html>
